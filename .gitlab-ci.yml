image: docker:latest

variables:
  DOCKER_DRIVER: overlay2
  DEPLOY_REGISTRY: ${CI_REGISTRY_IMAGE}

services:
  - docker:dind


stages:
  - build-docker
  - build-base
  - build-lang-base
  - build-lang-specific
  - release


before_script:
  - docker login -u gitlab-ci-token -p ${CI_JOB_TOKEN} ${CI_REGISTRY}



# -----------------------------------------
# --- Docker Images
# -----------------------------------------
build-docker-build:
  stage: build-docker
  script:
    - script/build-image.sh docker-build docker/docker-build


# -----------------------------------------
# --- Base Images
# -----------------------------------------
build-base:
  stage: build-base
  script:
    - script/build-image.sh base base


# -----------------------------------------
# --- Language Base Images
# -----------------------------------------
build-base-cpp:
  stage: build-lang-base
  script:
    - script/build-image.sh base-cpp cpp/base


# -----------------------------------------
# --- C++ and C Images
# -----------------------------------------
build_c_cpp:
  parallel:
    matrix:
      - COMPILER: gcc
        VERSION: [10, 9, 8, 7, 6]
      - COMPILER: clang
        VERSION: [10, 9, 8, 7, 6, 5]
      - COMPILER: arm-none-eabi-gcc
        VERSION: [9]
  stage: build-lang-specific
  script:
    - script/build-image.sh ${COMPILER}-${VERSION} cpp/${COMPILER} ${VERSION}


# -----------------------------------------
# --- Java
# -----------------------------------------
build_java:
  parallel:
    matrix:
      - JDK: openjdk
        VERSION: [14, 13, 12, 11, 8]
  stage: build-lang-specific
  script:
    - script/build-image.sh ${JDK}-${VERSION}-maven java/maven ${VERSION}


# -----------------------------------------
# --- Release
# -----------------------------------------
release-stable:
  stage: release
  script:
    # Base
    - script/release-image.sh docker-build
    - script/release-image.sh base
    # C++
    - script/release-image.sh base-cpp
    - script/release-image.sh gcc-10
    - script/release-image.sh gcc-9
    - script/release-image.sh gcc-8
    - script/release-image.sh gcc-7
    - script/release-image.sh gcc-6
    - script/release-image.sh clang-10
    - script/release-image.sh clang-9
    - script/release-image.sh clang-8
    - script/release-image.sh clang-7
    - script/release-image.sh clang-6
    - script/release-image.sh clang-5
    - script/release-image.sh arm-none-eabi-gcc
    # Java
    - script/release-image.sh openjdk-14-maven
    - script/release-image.sh openjdk-13-maven
    - script/release-image.sh openjdk-12-maven
    - script/release-image.sh openjdk-11-maven
    - script/release-image.sh openjdk-8-maven
  only:
    - master
